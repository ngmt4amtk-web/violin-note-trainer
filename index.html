<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Èü≥Á®ã„Éâ„É™„É´</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{
  height:100%;
  font-family:-apple-system,BlinkMacSystemFont,'Hiragino Sans',sans-serif;
  background:#e8ecf2;color:#1a1a2e;overflow:hidden;
  -webkit-user-select:none;user-select:none;
  -webkit-tap-highlight-color:transparent;
}
#app{display:flex;flex-direction:column;height:100%;padding-top:env(safe-area-inset-top)}
.screen{display:none;flex-direction:column;flex:1;min-height:0}
.screen.visible{display:flex}

/* Start */
#startScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;padding:40px 24px}
.start-title{color:#4f8cff;font-size:20px;font-weight:700;margin-bottom:6px}
.start-sub{color:#4b5563;font-size:12px;margin-bottom:28px;text-align:center;line-height:1.6}
.start-btn{
  width:120px;height:120px;border-radius:60px;
  background:#fff;border:2px solid #4f8cff40;
  color:#4f8cff;font-size:15px;font-weight:600;
  cursor:pointer;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:8px;
  transition:all .15s;font-family:inherit;
  box-shadow:0 2px 8px rgba(79,140,255,.12);
}
.start-btn:active{transform:scale(.93);border-color:#4f8cff}
.start-btn svg{width:36px;height:36px}
.start-hint{color:#6b7280;font-size:12px;margin-top:20px}
.error-msg{color:#e74c3c;font-size:13px;margin-top:16px;text-align:center;line-height:1.6}

/* Header */
.header{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;flex-shrink:0}
.header .h-title{font-size:15px;font-weight:700;color:#4b5563}
.header .h-btn{
  background:none;border:none;color:#4f8cff;font-size:13px;font-weight:600;
  cursor:pointer;font-family:inherit;padding:6px 12px;
}
.ta-timer{font-size:15px;font-weight:700;color:#4f8cff;font-variant-numeric:tabular-nums}

/* Setup */
.setup-section{margin:0 16px 4px;font-size:10px;color:#6b7280;font-weight:600;letter-spacing:.3px;text-transform:uppercase}
.mode-toggle,.diff-toggle{
  display:flex;gap:0;margin:0 16px 8px;
  background:#fff;border-radius:10px;overflow:hidden;border:1px solid #cbd5e1;
}
.mode-opt,.diff-opt{
  flex:1;padding:8px 2px;text-align:center;
  font-size:11px;font-weight:600;color:#6b7280;
  background:none;border:none;cursor:pointer;font-family:inherit;transition:all .15s;
}
.mode-opt.active{color:#4f8cff;background:#eff3ff}
.diff-opt.active{color:#4f8cff;background:#eff3ff}
.diff-opt[data-diff="easy"].active{color:#f59e0b;background:#fffbeb}
.mode-desc{display:block;font-size:8px;font-weight:400;opacity:.6;margin-top:1px}

.setup-content{flex:1;overflow-y:auto;padding:0 16px 120px;-webkit-overflow-scrolling:touch}
.oct-label{font-size:11px;color:#6b7280;font-weight:600;margin:12px 0 6px;letter-spacing:.5px}
.oct-label:first-child{margin-top:0}
.note-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.note-btn{
  padding:8px 2px;border-radius:8px;
  background:#fff;border:1.5px solid #cbd5e1;
  color:#4b5563;cursor:pointer;text-align:center;
  font-family:inherit;transition:all .12s;
}
.note-btn:active{transform:scale(.93)}
.note-btn .nb-kana{display:block;font-size:12px;font-weight:700;line-height:1.2}
.note-btn .nb-oct{display:block;font-size:9px;opacity:.5;margin-top:1px}

/* Selected notes */
.sel-area{
  position:fixed;bottom:0;left:0;right:0;
  background:#ffffffee;backdrop-filter:blur(12px);
  padding:10px 16px env(safe-area-inset-bottom,10px);
  border-top:1px solid #cbd5e1;z-index:10;
}
.sel-row{display:flex;align-items:center;gap:6px;margin-bottom:8px;min-height:32px;flex-wrap:wrap}
.sel-chip{
  display:inline-flex;align-items:center;gap:3px;
  padding:4px 10px;border-radius:6px;
  background:#dfe3eb;font-size:12px;font-weight:600;color:#4a5568;
  cursor:pointer;transition:all .12s;
}
.sel-chip:active{transform:scale(.9)}
.sel-chip .chip-x{color:#6b7280;font-size:10px}
.sel-bottom{display:flex;align-items:center;justify-content:space-between}
.sel-count{font-size:12px;color:#6b7280}
.sel-count em{font-style:normal;color:#4f8cff}
.sel-actions{display:flex;gap:8px}
.sel-clear{
  background:none;border:1px solid #b0b8c8;color:#6b7280;
  padding:8px 14px;border-radius:8px;font-size:12px;
  font-weight:600;cursor:pointer;font-family:inherit;
}
.sel-start{
  background:#4f8cff;border:none;color:#fff;
  padding:8px 20px;border-radius:8px;font-size:14px;
  font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s;
}
.sel-start:disabled{opacity:.3;cursor:default}

/* Practice */
.prac-progress{display:flex;align-items:center;gap:8px;padding:0 16px;margin-bottom:8px}
.prac-progress .pp-text{font-size:12px;color:#6b7280;font-weight:600;white-space:nowrap}
.pp-bar{flex:1;height:4px;background:#cbd5e1;border-radius:2px;overflow:hidden}
.pp-fill{height:100%;background:#4f8cff;border-radius:2px;transition:width .3s}
.pp-round{font-size:11px;color:#4f8cff;font-weight:700;padding:0 16px;margin-bottom:4px}

.seq-dots{display:flex;gap:6px;padding:0 16px;margin-bottom:10px;overflow-x:auto;flex-shrink:0}
.seq-dot{
  display:flex;flex-direction:column;align-items:center;gap:2px;min-width:36px;flex-shrink:0;
}
.seq-dot .dot-circle{
  width:20px;height:20px;border-radius:10px;border:2px solid #b0b8c8;
  display:flex;align-items:center;justify-content:center;
  font-size:10px;color:#6b7280;transition:all .3s;
}
.seq-dot.done .dot-circle{background:#4f8cff;border-color:#4f8cff;color:#fff}
.seq-dot.current .dot-circle{background:#4f8cff;border-color:#4f8cff;color:#fff;transform:scale(1.2)}
.seq-dot .dot-name{font-size:9px;color:#6b7280;white-space:nowrap}
.seq-dot.current .dot-name{color:#4f8cff;font-weight:600}

.prac-content{flex:1;overflow-y:auto;padding:0 16px 16px;-webkit-overflow-scrolling:touch}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:8px;border:1px solid #cbd5e1}

.target-display{text-align:center}
.target-kana{font-size:52px;font-weight:800;line-height:1.1}
.target-info{font-size:13px;color:#4b5563;margin-top:4px}
.target-range{font-size:11px;color:#6b7280;margin-top:6px}
.target-range em{font-style:normal;color:#4b5563}

#staffCanvas{display:block;margin:8px auto 0}
#zoneCanvas{display:block;margin:0 auto}

.detect-display{text-align:center;margin-top:8px}
.detect-hz{font-size:36px;font-weight:800;line-height:1}
.detect-pos{font-size:18px;font-weight:700;margin-top:6px;min-height:26px}
.detect-cents{font-size:12px;color:#6b7280;margin-top:4px}
.pos-low{color:#f5a623}
.pos-piano{color:#4f8cff}
.pos-high{color:#2ecc71}
.pos-out{color:#e74c3c}
.pos-silent{color:#8892a4}

/* Auto progress */
.auto-bar-wrap{margin-top:12px;text-align:center}
.auto-bar{height:6px;background:#cbd5e1;border-radius:3px;overflow:hidden;margin-bottom:6px}
.auto-fill{height:100%;background:#4f8cff;border-radius:3px;transition:width .1s}
.auto-label{font-size:10px;color:#6b7280}

/* Confirm button */
.confirm-btn{
  display:block;width:100%;margin-top:12px;padding:14px;
  border-radius:10px;font-size:16px;font-weight:700;
  border:none;cursor:pointer;font-family:inherit;transition:all .15s;
}
.confirm-btn.ready{background:#4f8cff;color:#fff}
.confirm-btn.waiting{background:#cbd5e1;color:#6b7280;cursor:pointer}

.prac-stop{
  display:block;width:100%;margin-top:8px;padding:10px;
  border-radius:10px;font-size:13px;font-weight:600;
  background:none;border:1px solid #b0b8c8;color:#6b7280;
  cursor:pointer;font-family:inherit;
}

/* Result */
#resultScreen .result-content{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;
}
.result-icon{font-size:64px;margin-bottom:16px}
.result-title{font-size:24px;font-weight:800;color:#4f8cff;margin-bottom:8px}
.result-sub{font-size:14px;color:#4b5563;margin-bottom:32px;text-align:center}
.result-actions{display:flex;gap:12px}
.result-btn{
  padding:12px 24px;border-radius:10px;font-size:14px;font-weight:600;
  cursor:pointer;font-family:inherit;border:none;transition:all .15s;
}
.result-btn.primary{background:#4f8cff;color:#fff}
.result-btn.secondary{background:#dfe3eb;color:#4b5563;border:1px solid #cbd5e1}
</style>
</head>
<body>
<div id="app">

  <!-- Start Screen -->
  <div id="startScreen" class="screen visible">
    <div class="start-title">Èü≥Á®ã„Éâ„É™„É´</div>
    <div class="start-sub">ÈÅ∏„Çì„Å†Èü≥„Çí„Éû„Ç§„ÇØ„ÅßËÅ¥„ÅçÂèñ„Çä<br>3„Å§„ÅÆÈü≥Âæã„ÅÆÊ≠£Ëß£ÁØÑÂõ≤„ÅßÂà§ÂÆö</div>
    <button class="start-btn" id="startBtn">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M12 2a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z" fill="#4f8cff"/>
        <path d="M17.5 11c0 2.76-2.24 5-5.5 5s-5.5-2.24-5.5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-1.5z" fill="#4f8cff"/>
      </svg>
      „Çπ„Çø„Éº„Éà
    </button>
    <p class="start-hint">„Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
    <p class="error-msg" id="errorMsg" style="display:none"></p>
  </div>

  <!-- Setup Screen -->
  <div id="setupScreen" class="screen">
    <div class="header">
      <span class="h-title">Èü≥„ÇíÈÅ∏Êäû</span>
      <span class="h-title" style="font-size:11px;color:#6b7280">1„Äú8ÂÄãÔºàÂêå‰∏ÄÈü≥OKÔºâ</span>
    </div>

    <div class="setup-section">„É¢„Éº„Éâ</div>
    <div class="mode-toggle">
      <button class="mode-opt active" data-mode="auto">
        „Ç™„Éº„Éà<span class="mode-desc">Ê≠£Ëß£„ÅßËá™Âãï</span>
      </button>
      <button class="mode-opt" data-mode="confirm">
        Á¢∫Ë™ç<span class="mode-desc">ÊâãÂãï„ÅßÊ¨°„Å∏</span>
      </button>
      <button class="mode-opt" data-mode="repeat">
        „É™„Éî„Éº„Éà<span class="mode-desc">Áπ∞„ÇäËøî„Åó</span>
      </button>
      <button class="mode-opt" data-mode="timeattack">
        ‚è±„Çø„Ç§„É†<span class="mode-desc">ÊúÄÈÄü„ÇØ„É™„Ç¢</span>
      </button>
    </div>

    <div class="setup-section">Èõ£ÊòìÂ∫¶</div>
    <div class="diff-toggle">
      <button class="diff-opt" data-diff="easy">
        „Åã„Çì„Åü„Çì<span class="mode-desc">Âà§ÂÆö„ÇÜ„Çã„ÇÅ ¬±15¬¢</span>
      </button>
      <button class="diff-opt active" data-diff="normal">
        „Åµ„Å§„ÅÜ<span class="mode-desc">Ê®ôÊ∫ñ ¬±5¬¢</span>
      </button>
    </div>

    <div class="setup-content" id="noteGridArea"></div>

    <div class="sel-area" id="selArea">
      <div class="sel-row" id="selRow"></div>
      <div class="sel-bottom">
        <span class="sel-count" id="selCount"><em>0</em>/8</span>
        <div class="sel-actions">
          <button class="sel-clear" id="selClear">„ÇØ„É™„Ç¢</button>
          <button class="sel-start" id="selStart" disabled>Á∑¥ÁøíÈñãÂßã</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Practice Screen -->
  <div id="practiceScreen" class="screen">
    <div class="header">
      <span class="h-title" id="pracTitle">Èü≥Á®ã„Éâ„É™„É´</span>
      <span class="ta-timer" id="taTimer" style="display:none"></span>
      <button class="h-btn" id="pracStop">‰∏≠Ê≠¢</button>
    </div>

    <div class="pp-round" id="ppRound" style="display:none"></div>

    <div class="prac-progress">
      <span class="pp-text" id="ppText">1/6</span>
      <div class="pp-bar"><div class="pp-fill" id="ppFill"></div></div>
    </div>

    <div class="seq-dots" id="seqDots"></div>

    <div class="prac-content">
      <div class="card">
        <div class="target-display">
          <div class="target-kana" id="targetKana">„É©</div>
          <div class="target-info" id="targetInfo">A4 ¬∑ 442.0 Hz</div>
          <div class="target-range" id="targetRange">ÁØÑÂõ≤: <em>439.5 - 444.6 Hz</em></div>
        </div>
        <canvas id="staffCanvas"></canvas>
      </div>

      <div class="card">
        <canvas id="zoneCanvas"></canvas>
        <div class="detect-display">
          <div class="detect-hz pos-silent" id="detectHz">---</div>
          <div class="detect-pos pos-silent" id="detectPos">Èü≥„ÇíÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
          <div class="detect-cents" id="detectCents"></div>
        </div>

        <div class="auto-bar-wrap" id="autoWrap">
          <div class="auto-bar"><div class="auto-fill" id="autoFill"></div></div>
          <div class="auto-label" id="autoLabel">Ê≠£Ëß£ÁØÑÂõ≤„Çí0.5Áßí„Ç≠„Éº„Éó„ÅßÊ¨°„Å∏</div>
        </div>

        <button class="confirm-btn waiting" id="confirmBtn" style="display:none">
          Ê¨°„Å∏
        </button>
      </div>

      <button class="prac-stop" id="pracStop2">‰∏≠Ê≠¢„Åó„Å¶ÈÅ∏ÊäûÁîªÈù¢„Å∏</button>
    </div>
  </div>

  <!-- Result Screen -->
  <div id="resultScreen" class="screen">
    <div class="result-content">
      <div class="result-icon" id="resultIcon">&#10004;&#65039;</div>
      <div class="result-title" id="resultTitle">ÂÆå‰∫ÜÔºÅ</div>
      <div class="result-sub" id="resultSub">„Åô„Åπ„Å¶„ÅÆÈü≥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü</div>
      <div class="result-actions">
        <button class="result-btn secondary" id="resultBack">ÈÅ∏ÊäûÁîªÈù¢„Å∏</button>
        <button class="result-btn primary" id="resultRetry">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
      </div>
    </div>
  </div>

</div>

<script>
(function(){
'use strict';

// ===== CONSTANTS =====
var A4 = 442;
var AUTO_HOLD_MS = 500;
var TA_HOLD_MS = 300;
var NOTE_NAMES_SIMPLE = ['„Éâ','„Éâ‚ôØ','„É¨','„Éü‚ô≠','„Éü','„Éï„Ç°','„Éï„Ç°‚ôØ','„ÇΩ','„ÇΩ‚ôØ','„É©','„Ç∑‚ô≠','„Ç∑'];

var ALL_NOTES = [
  {midi:55,name:'G3',kana:'„ÇΩ',letter:4,acc:0,oct:3},
  {midi:56,name:'G‚ôØ3',kana:'„ÇΩ‚ôØ',letter:4,acc:1,oct:3},
  {midi:56,name:'A‚ô≠3',kana:'„É©‚ô≠',letter:5,acc:-1,oct:3},
  {midi:57,name:'A3',kana:'„É©',letter:5,acc:0,oct:3},
  {midi:58,name:'A‚ôØ3',kana:'„É©‚ôØ',letter:5,acc:1,oct:3},
  {midi:58,name:'B‚ô≠3',kana:'„Ç∑‚ô≠',letter:6,acc:-1,oct:3},
  {midi:59,name:'B3',kana:'„Ç∑',letter:6,acc:0,oct:3},
  {midi:59,name:'C‚ô≠4',kana:'„Éâ‚ô≠',letter:0,acc:-1,oct:4},
  {midi:60,name:'B‚ôØ3',kana:'„Ç∑‚ôØ',letter:6,acc:1,oct:3},
  {midi:60,name:'C4',kana:'„Éâ',letter:0,acc:0,oct:4},
  {midi:61,name:'C‚ôØ4',kana:'„Éâ‚ôØ',letter:0,acc:1,oct:4},
  {midi:61,name:'D‚ô≠4',kana:'„É¨‚ô≠',letter:1,acc:-1,oct:4},
  {midi:62,name:'D4',kana:'„É¨',letter:1,acc:0,oct:4},
  {midi:63,name:'D‚ôØ4',kana:'„É¨‚ôØ',letter:1,acc:1,oct:4},
  {midi:63,name:'E‚ô≠4',kana:'„Éü‚ô≠',letter:2,acc:-1,oct:4},
  {midi:64,name:'E4',kana:'„Éü',letter:2,acc:0,oct:4},
  {midi:64,name:'F‚ô≠4',kana:'„Éï„Ç°‚ô≠',letter:3,acc:-1,oct:4},
  {midi:65,name:'E‚ôØ4',kana:'„Éü‚ôØ',letter:2,acc:1,oct:4},
  {midi:65,name:'F4',kana:'„Éï„Ç°',letter:3,acc:0,oct:4},
  {midi:66,name:'F‚ôØ4',kana:'„Éï„Ç°‚ôØ',letter:3,acc:1,oct:4},
  {midi:66,name:'G‚ô≠4',kana:'„ÇΩ‚ô≠',letter:4,acc:-1,oct:4},
  {midi:67,name:'G4',kana:'„ÇΩ',letter:4,acc:0,oct:4},
  {midi:68,name:'G‚ôØ4',kana:'„ÇΩ‚ôØ',letter:4,acc:1,oct:4},
  {midi:68,name:'A‚ô≠4',kana:'„É©‚ô≠',letter:5,acc:-1,oct:4},
  {midi:69,name:'A4',kana:'„É©',letter:5,acc:0,oct:4},
  {midi:70,name:'A‚ôØ4',kana:'„É©‚ôØ',letter:5,acc:1,oct:4},
  {midi:70,name:'B‚ô≠4',kana:'„Ç∑‚ô≠',letter:6,acc:-1,oct:4},
  {midi:71,name:'B4',kana:'„Ç∑',letter:6,acc:0,oct:4},
  {midi:71,name:'C‚ô≠5',kana:'„Éâ‚ô≠',letter:0,acc:-1,oct:5},
  {midi:72,name:'B‚ôØ4',kana:'„Ç∑‚ôØ',letter:6,acc:1,oct:4},
  {midi:72,name:'C5',kana:'„Éâ',letter:0,acc:0,oct:5},
  {midi:73,name:'C‚ôØ5',kana:'„Éâ‚ôØ',letter:0,acc:1,oct:5},
  {midi:73,name:'D‚ô≠5',kana:'„É¨‚ô≠',letter:1,acc:-1,oct:5},
  {midi:74,name:'D5',kana:'„É¨',letter:1,acc:0,oct:5},
  {midi:75,name:'D‚ôØ5',kana:'„É¨‚ôØ',letter:1,acc:1,oct:5},
  {midi:75,name:'E‚ô≠5',kana:'„Éü‚ô≠',letter:2,acc:-1,oct:5},
  {midi:76,name:'E5',kana:'„Éü',letter:2,acc:0,oct:5},
  {midi:76,name:'F‚ô≠5',kana:'„Éï„Ç°‚ô≠',letter:3,acc:-1,oct:5},
  {midi:77,name:'E‚ôØ5',kana:'„Éü‚ôØ',letter:2,acc:1,oct:5},
  {midi:77,name:'F5',kana:'„Éï„Ç°',letter:3,acc:0,oct:5},
  {midi:78,name:'F‚ôØ5',kana:'„Éï„Ç°‚ôØ',letter:3,acc:1,oct:5},
  {midi:78,name:'G‚ô≠5',kana:'„ÇΩ‚ô≠',letter:4,acc:-1,oct:5},
  {midi:79,name:'G5',kana:'„ÇΩ',letter:4,acc:0,oct:5},
  {midi:80,name:'G‚ôØ5',kana:'„ÇΩ‚ôØ',letter:4,acc:1,oct:5},
  {midi:80,name:'A‚ô≠5',kana:'„É©‚ô≠',letter:5,acc:-1,oct:5},
  {midi:81,name:'A5',kana:'„É©',letter:5,acc:0,oct:5},
  {midi:82,name:'A‚ôØ5',kana:'„É©‚ôØ',letter:5,acc:1,oct:5},
  {midi:82,name:'B‚ô≠5',kana:'„Ç∑‚ô≠',letter:6,acc:-1,oct:5},
  {midi:83,name:'B5',kana:'„Ç∑',letter:6,acc:0,oct:5},
  {midi:83,name:'C‚ô≠6',kana:'„Éâ‚ô≠',letter:0,acc:-1,oct:6},
  {midi:84,name:'B‚ôØ5',kana:'„Ç∑‚ôØ',letter:6,acc:1,oct:5},
  {midi:84,name:'C6',kana:'„Éâ',letter:0,acc:0,oct:6},
  {midi:85,name:'C‚ôØ6',kana:'„Éâ‚ôØ',letter:0,acc:1,oct:6},
  {midi:85,name:'D‚ô≠6',kana:'„É¨‚ô≠',letter:1,acc:-1,oct:6},
  {midi:86,name:'D6',kana:'„É¨',letter:1,acc:0,oct:6},
  {midi:87,name:'D‚ôØ6',kana:'„É¨‚ôØ',letter:1,acc:1,oct:6},
  {midi:87,name:'E‚ô≠6',kana:'„Éü‚ô≠',letter:2,acc:-1,oct:6},
  {midi:88,name:'E6',kana:'„Éü',letter:2,acc:0,oct:6},
  {midi:88,name:'F‚ô≠6',kana:'„Éï„Ç°‚ô≠',letter:3,acc:-1,oct:6},
  {midi:89,name:'E‚ôØ6',kana:'„Éü‚ôØ',letter:2,acc:1,oct:6},
  {midi:89,name:'F6',kana:'„Éï„Ç°',letter:3,acc:0,oct:6},
  {midi:90,name:'F‚ôØ6',kana:'„Éï„Ç°‚ôØ',letter:3,acc:1,oct:6},
  {midi:90,name:'G‚ô≠6',kana:'„ÇΩ‚ô≠',letter:4,acc:-1,oct:6},
  {midi:91,name:'G6',kana:'„ÇΩ',letter:4,acc:0,oct:6}
];

var NOTE_GROUPS = [
  {label:'Á¨¨3„Ç™„ÇØ„Çø„Éº„Éñ (G3„ÄúB3)', start:0, end:6},
  {label:'Á¨¨4„Ç™„ÇØ„Çø„Éº„Éñ (C4„ÄúB4)', start:7, end:27},
  {label:'Á¨¨5„Ç™„ÇØ„Çø„Éº„Éñ (C5„ÄúB5)', start:28, end:48},
  {label:'Á¨¨6„Ç™„ÇØ„Çø„Éº„Éñ (C6„ÄúG6)', start:49, end:63}
];

var OPEN_MIDS = [55,62,69,76];
var STR_COLORS = ['#4f8cff','#f5a623','#e74c3c','#2ecc71'];

var INTERVALS = [
  {name:'ÂÆåÂÖ®1Â∫¶',   ji:  0, pyth:  0},
  {name:'Áü≠2Â∫¶',     ji: 12, pyth:-10},
  {name:'Èï∑2Â∫¶',     ji:  4, pyth:  4},
  {name:'Áü≠3Â∫¶',     ji: 16, pyth: -6},
  {name:'Èï∑3Â∫¶',     ji:-14, pyth:  8},
  {name:'ÂÆåÂÖ®4Â∫¶',   ji: -2, pyth: -2},
  {name:'Â¢ó4Â∫¶/Ê∏õ5Â∫¶', ji:-10, pyth: 12},
  {name:'ÂÆåÂÖ®5Â∫¶',   ji:  2, pyth:  2},
  {name:'Áü≠6Â∫¶',     ji: 14, pyth: -8},
  {name:'Èï∑6Â∫¶',     ji:-16, pyth:  6},
  {name:'Áü≠7Â∫¶',     ji: -4, pyth: -4},
  {name:'Èï∑7Â∫¶',     ji:-12, pyth: 10}
];

// ===== HELPERS =====
function etFreq(midi){ return A4 * Math.pow(2, (midi - 69) / 12); }
function centsFrom(f, t){ return 1200 * Math.log2(f / t); }
function noteStaffPos(note){ return (note.oct - 4) * 7 + note.letter - 2; }
function getStringIdx(midi){
  for(var i = OPEN_MIDS.length - 1; i >= 0; i--){ if(midi >= OPEN_MIDS[i]) return i; }
  return 0;
}
function getStringColor(midi){ return STR_COLORS[getStringIdx(midi)]; }
function getInterval(midi){
  var ref = OPEN_MIDS[getStringIdx(midi)];
  return (midi - ref) % 12;
}

function getRangeBuffer(){ return difficulty === 'easy' ? 15 : 5; }

function getRange(midi){
  var iv = getInterval(midi);
  var data = INTERVALS[iv];
  var buf = getRangeBuffer();
  var lo = Math.min(0, data.ji, data.pyth) - buf;
  var hi = Math.max(0, data.ji, data.pyth) + buf;
  var et = etFreq(midi);
  return {
    lo: lo, hi: hi,
    loHz: et * Math.pow(2, lo / 1200),
    hiHz: et * Math.pow(2, hi / 1200),
    etHz: et, ji: data.ji, pyth: data.pyth,
    ivName: data.name
  };
}

function getDetectedNoteName(freq){
  var midi = Math.round(69 + 12 * Math.log2(freq / A4));
  var noteIdx = ((midi % 12) + 12) % 12;
  var oct = Math.floor(midi / 12) - 1;
  return NOTE_NAMES_SIMPLE[noteIdx] + oct;
}

function getHoldMs(){ return practiceMode === 'timeattack' ? TA_HOLD_MS : AUTO_HOLD_MS; }

// ===== STATE =====
var selectedNotes = [];
var practiceMode = 'auto';
var difficulty = 'normal';
var currentIdx = 0;
var audioCtx = null, analyser = null, audioBuf = null;
var isRunning = false;
var smoothPitch = 0, silCnt = 0;
var holdStart = 0, isInRange = false;
var currentScreen = 'start';
var zoneCtx = null, staffCtx = null, zW = 0, zH = 70, sW = 0, sH = 140;
var repeatRound = 1;
var totalNotesCompleted = 0;
var taStart = 0, taElapsed = 0, taRunning = false;

// ===== YIN =====
function yin(buf, sr){
  var th = 0.15, half = Math.floor(buf.length / 2);
  var tMin = Math.floor(sr / 2800), tMax = Math.min(Math.ceil(sr / 170), half);
  var diff = new Float32Array(half);
  for(var t = 0; t < tMax; t++){
    var s = 0;
    for(var i = 0; i < half; i++){ var d = buf[i] - buf[i+t]; s += d * d; }
    diff[t] = s;
  }
  var cm = new Float32Array(half); cm[0] = 1; var run = 0;
  for(var t = 1; t < tMax; t++){ run += diff[t]; cm[t] = diff[t] * t / run; }
  var est = -1;
  for(var t = tMin; t < tMax; t++){
    if(cm[t] < th){
      while(t + 1 < tMax && cm[t+1] < cm[t]) t++;
      est = t; break;
    }
  }
  if(est < 0) return -1;
  var x0 = est > 0 ? est - 1 : est, x2 = est + 1 < half ? est + 1 : est;
  if(x0 === est) var bt = cm[est] <= cm[x2] ? est : x2;
  else if(x2 === est) var bt = cm[est] <= cm[x0] ? est : x0;
  else { var a = cm[x0], b = cm[est], c = cm[x2]; var bt = est + (c - a) / (2 * (2*b - c - a)); }
  return sr / bt;
}
function rms(buf){ var s = 0; for(var i = 0; i < buf.length; i++) s += buf[i]*buf[i]; return Math.sqrt(s/buf.length); }

// ===== NOTE GRID =====
function buildNoteGrid(){
  var area = document.getElementById('noteGridArea');
  var html = '';
  for(var g = 0; g < NOTE_GROUPS.length; g++){
    var gr = NOTE_GROUPS[g];
    html += '<div class="oct-label">' + gr.label + '</div><div class="note-grid">';
    for(var i = gr.start; i <= gr.end; i++){
      var note = ALL_NOTES[i];
      var col = getStringColor(note.midi);
      html += '<button class="note-btn" data-nidx="' + i + '" style="border-color:' + col + '40">'
        + '<span class="nb-kana" style="color:' + col + '">' + note.kana + '</span>'
        + '<span class="nb-oct">' + note.name + '</span></button>';
    }
    html += '</div>';
  }
  area.innerHTML = html;
  area.querySelectorAll('.note-btn').forEach(function(btn){
    btn.addEventListener('click', function(){ addNote(parseInt(btn.dataset.nidx)); });
  });
}

function addNote(nidx){
  if(selectedNotes.length >= 8) return;
  selectedNotes.push(ALL_NOTES[nidx]);
  renderSelected();
}

function removeNote(idx){
  selectedNotes.splice(idx, 1);
  renderSelected();
}

function renderSelected(){
  var row = document.getElementById('selRow');
  var html = '';
  for(var i = 0; i < selectedNotes.length; i++){
    var note = selectedNotes[i];
    var col = getStringColor(note.midi);
    html += '<span class="sel-chip" data-idx="' + i + '" style="border-left:3px solid ' + col + '">'
      + note.kana + note.oct + ' <span class="chip-x">√ó</span></span>';
  }
  row.innerHTML = html;
  row.querySelectorAll('.sel-chip').forEach(function(chip){
    chip.addEventListener('click', function(){ removeNote(parseInt(chip.dataset.idx)); });
  });
  var n = selectedNotes.length;
  document.getElementById('selCount').innerHTML = '<em>' + n + '</em>/8';
  document.getElementById('selStart').disabled = n < 1;
}

// ===== CANVAS =====
function dprCanvas(canvas, w, h){
  var dpr = window.devicePixelRatio || 1;
  canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
  canvas.width = Math.round(w * dpr); canvas.height = Math.round(h * dpr);
  var ctx = canvas.getContext('2d'); ctx.scale(dpr, dpr); return ctx;
}

// ===== STAFF =====
function setupStaff(){
  var c = document.getElementById('staffCanvas'); if(!c) return;
  var pw = c.parentElement.clientWidth - 32;
  sW = Math.max(pw, 200); sH = 140;
  staffCtx = dprCanvas(c, sW, sH);
}

function drawStaff(note){
  var ctx = staffCtx; if(!ctx) return;
  ctx.clearRect(0, 0, sW, sH);
  var LS = 12, HS = LS / 2;
  var sl = 44, sr = sW - 16, bly = sH * 0.68;

  ctx.strokeStyle = '#a0a8b8'; ctx.lineWidth = 1;
  for(var i = 0; i < 5; i++){
    var y = bly - i * LS;
    ctx.beginPath(); ctx.moveTo(sl, y); ctx.lineTo(sr, y); ctx.stroke();
  }

  var fs = LS * 5.8;
  ctx.save();
  ctx.font = fs + 'px Times,serif'; ctx.fillStyle = '#6b7280'; ctx.textBaseline = 'alphabetic';
  var gLineY = bly - LS;
  var tx = sl + 4, ty = gLineY + fs * 0.36;
  var m = ctx.measureText('\uD834\uDD1E');
  if(m.width > 2) ctx.fillText('\uD834\uDD1E', tx, ty);
  else { ctx.font = 'bold ' + (LS*1.5) + 'px serif'; ctx.fillStyle = '#6b7280'; ctx.textBaseline = 'middle'; ctx.textAlign = 'center'; ctx.fillText('G', sl + 16, gLineY); }
  ctx.restore();

  if(!note) return;
  var sp = noteStaffPos(note);
  var nx = (sl + sr) / 2 + 8;
  var ny = bly - sp * HS;
  var nr = HS * 1.3;

  ctx.strokeStyle = '#6b7280'; ctx.lineWidth = 1;
  if(sp <= -2){ for(var p = -2; p >= sp; p -= 2){ var ly = bly - p * HS; ctx.beginPath(); ctx.moveTo(nx-nr*2, ly); ctx.lineTo(nx+nr*2, ly); ctx.stroke(); } }
  if(sp >= 10){ for(var p = 10; p <= sp; p += 2){ var ly = bly - p * HS; ctx.beginPath(); ctx.moveTo(nx-nr*2, ly); ctx.lineTo(nx+nr*2, ly); ctx.stroke(); } }

  if(note.acc !== 0){
    var accSign = note.acc === 1 ? '‚ôØ' : '‚ô≠';
    ctx.fillStyle = '#374151'; ctx.font = 'bold ' + (LS*1.1) + 'px -apple-system,sans-serif';
    ctx.textAlign = 'right'; ctx.textBaseline = 'middle';
    ctx.fillText(accSign, nx - nr - 5, ny + 1);
  }

  var col = getStringColor(note.midi);
  ctx.save(); ctx.translate(nx, ny); ctx.rotate(-0.3);
  ctx.beginPath(); ctx.ellipse(0, 0, nr, nr * 0.72, 0, 0, Math.PI * 2);
  ctx.fillStyle = col; ctx.fill(); ctx.restore();

  var sh = LS * 3.5;
  ctx.strokeStyle = col; ctx.lineWidth = 1.5;
  ctx.beginPath();
  if(sp < 4){ ctx.moveTo(nx + nr*0.9, ny); ctx.lineTo(nx + nr*0.9, ny - sh); }
  else { ctx.moveTo(nx - nr*0.9, ny); ctx.lineTo(nx - nr*0.9, ny + sh); }
  ctx.stroke();
}

// ===== ZONE BAR =====
function setupZone(){
  var c = document.getElementById('zoneCanvas'); if(!c) return;
  var pw = c.parentElement.clientWidth - 32;
  zW = Math.max(pw, 200); zH = 70;
  zoneCtx = dprCanvas(c, zW, zH);
}

function drawZone(midi, detectedCents){
  var ctx = zoneCtx; if(!ctx) return;
  var w = zW, h = zH;
  ctx.clearRect(0, 0, w, h);

  var mx = 12, ml = mx, mr = w - mx, mw = mr - ml;
  var cy = h * 0.42, bh = 4, cx = ml + mw / 2;
  var displayRange = 40;

  var range = getRange(midi);

  ctx.fillStyle = '#b0b8c8';
  ctx.beginPath();
  if(ctx.roundRect) ctx.roundRect(ml, cy - bh/2, mw, bh, [bh/2]);
  else ctx.rect(ml, cy - bh/2, mw, bh);
  ctx.fill();

  var zLoX = cx + (range.lo / displayRange) * (mw / 2);
  var zHiX = cx + (range.hi / displayRange) * (mw / 2);
  ctx.fillStyle = '#4f8cff18';
  ctx.beginPath();
  if(ctx.roundRect) ctx.roundRect(zLoX, cy - 18, zHiX - zLoX, 36, [4]);
  else ctx.rect(zLoX, cy - 18, zHiX - zLoX, 36);
  ctx.fill();
  ctx.strokeStyle = '#4f8cff40'; ctx.lineWidth = 1;
  ctx.beginPath();
  if(ctx.roundRect) ctx.roundRect(zLoX, cy - 18, zHiX - zLoX, 36, [4]);
  else ctx.rect(zLoX, cy - 18, zHiX - zLoX, 36);
  ctx.stroke();

  var refs = [
    { off: range.ji, label: 'Á¥îÊ≠£Âæã', col: '#f5a623' },
    { off: 0, label: 'ET', col: '#6b7280' },
    { off: range.pyth, label: '„Éî„Çø„Ç¥„É©„Çπ', col: '#4f8cff' }
  ];
  for(var i = 0; i < refs.length; i++){
    var r = refs[i];
    var rx = cx + (r.off / displayRange) * (mw / 2);
    ctx.strokeStyle = r.col; ctx.lineWidth = 1.5; ctx.globalAlpha = 0.7;
    ctx.beginPath(); ctx.moveTo(rx, cy - 14); ctx.lineTo(rx, cy + 14); ctx.stroke();
    ctx.globalAlpha = 0.5;
    ctx.fillStyle = r.col; ctx.font = '9px -apple-system,sans-serif';
    ctx.textAlign = 'center'; ctx.textBaseline = 'top';
    ctx.fillText(r.label, rx, cy + 17);
    ctx.globalAlpha = 1;
  }

  for(var t = -40; t <= 40; t += 10){
    var tx = ml + mw * (t + displayRange) / (displayRange * 2);
    ctx.strokeStyle = t === 0 ? '#6b7280' : '#b0b8c8'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(tx, cy - 3); ctx.lineTo(tx, cy + 3); ctx.stroke();
  }

  ctx.fillStyle = '#6b7280'; ctx.font = '9px -apple-system,sans-serif'; ctx.textBaseline = 'bottom';
  ctx.textAlign = 'left'; ctx.fillText('‚ô≠ ‰Ωé', ml, h - 2);
  ctx.textAlign = 'right'; ctx.fillText('‚ôØ È´ò', mr, h - 2);

  if(detectedCents !== null){
    var cl = Math.max(-displayRange, Math.min(displayRange, detectedCents));
    var ix = cx + (cl / displayRange) * (mw / 2);
    var inRange = detectedCents >= range.lo && detectedCents <= range.hi;
    var col = inRange ? '#4f8cff' : '#e74c3c';

    var g = ctx.createRadialGradient(ix, cy, 0, ix, cy, 16);
    g.addColorStop(0, col + '55'); g.addColorStop(1, col + '00');
    ctx.fillStyle = g; ctx.fillRect(ix - 16, cy - 16, 32, 32);

    ctx.beginPath(); ctx.arc(ix, cy, 5, 0, Math.PI * 2);
    ctx.fillStyle = col; ctx.fill();
  }
}

// ===== PRACTICE =====
function startPractice(){
  currentIdx = 0;
  holdStart = 0;
  isInRange = false;
  repeatRound = 1;
  totalNotesCompleted = 0;
  taElapsed = 0;
  taRunning = false;

  document.getElementById('taTimer').style.display = practiceMode === 'timeattack' ? 'inline' : 'none';
  document.getElementById('taTimer').textContent = '‚è± 0.0Áßí';
  document.getElementById('ppRound').style.display = practiceMode === 'repeat' ? 'block' : 'none';
  document.getElementById('ppRound').textContent = '1Âë®ÁõÆ';

  if(practiceMode === 'timeattack'){
    document.getElementById('autoLabel').textContent = '0.3Áßí„Ç≠„Éº„Éó„ÅßÊ¨°„Å∏ÔºÅ';
  } else {
    document.getElementById('autoLabel').textContent = 'Ê≠£Ëß£ÁØÑÂõ≤„Çí0.5Áßí„Ç≠„Éº„Éó„ÅßÊ¨°„Å∏';
  }

  document.getElementById('pracStop2').textContent =
    (practiceMode === 'repeat' || practiceMode === 'timeattack') ? '‰∏≠Ê≠¢„Åó„Å¶ÁµêÊûú„ÇíË¶ã„Çã' : '‰∏≠Ê≠¢„Åó„Å¶ÈÅ∏ÊäûÁîªÈù¢„Å∏';

  showScreen('practice');
  updateTarget();

  if(practiceMode === 'timeattack'){
    taStart = performance.now();
    taRunning = true;
    updateTimerDisplay();
  }
}

function updateTimerDisplay(){
  if(!taRunning) return;
  taElapsed = performance.now() - taStart;
  document.getElementById('taTimer').textContent = '‚è± ' + (taElapsed / 1000).toFixed(1) + 'Áßí';
  requestAnimationFrame(updateTimerDisplay);
}

function updateTarget(){
  var note = selectedNotes[currentIdx];
  var midi = note.midi;
  var range = getRange(midi);
  var col = getStringColor(midi);

  document.getElementById('targetKana').textContent = note.kana;
  document.getElementById('targetKana').style.color = col;
  document.getElementById('targetInfo').textContent = note.name + ' ¬∑ ' + range.etHz.toFixed(1) + ' Hz (ET)';
  document.getElementById('targetRange').innerHTML = 'ÁØÑÂõ≤: <em>' + range.loHz.toFixed(1) + ' - ' + range.hiHz.toFixed(1) + ' Hz</em>  (' + range.ivName + ')';

  document.getElementById('ppText').textContent = (currentIdx + 1) + '/' + selectedNotes.length;
  document.getElementById('ppFill').style.width = (currentIdx / selectedNotes.length * 100) + '%';

  if(practiceMode === 'repeat'){
    document.getElementById('ppRound').textContent = repeatRound + 'Âë®ÁõÆ';
  }

  var dotsHtml = '';
  for(var i = 0; i < selectedNotes.length; i++){
    var ni = selectedNotes[i];
    var cls = i < currentIdx ? 'done' : i === currentIdx ? 'current' : '';
    var sym = i < currentIdx ? '‚úì' : (i + 1);
    dotsHtml += '<div class="seq-dot ' + cls + '">'
      + '<div class="dot-circle">' + sym + '</div>'
      + '<div class="dot-name">' + ni.kana + ni.oct + '</div></div>';
  }
  document.getElementById('seqDots').innerHTML = dotsHtml;

  setTimeout(function(){
    setupStaff(); drawStaff(note);
    setupZone(); drawZone(midi, null);
  }, 30);

  document.getElementById('detectHz').textContent = '---';
  document.getElementById('detectHz').className = 'detect-hz pos-silent';
  document.getElementById('detectPos').textContent = 'Èü≥„ÇíÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
  document.getElementById('detectPos').className = 'detect-pos pos-silent';
  document.getElementById('detectCents').textContent = '';

  var useAuto = practiceMode !== 'confirm';
  document.getElementById('autoWrap').style.display = useAuto ? 'block' : 'none';
  document.getElementById('confirmBtn').style.display = 'block';
  document.getElementById('autoFill').style.width = '0%';
  document.getElementById('confirmBtn').className = 'confirm-btn ready';
  document.getElementById('confirmBtn').textContent = useAuto ? '„Çπ„Ç≠„ÉÉ„Éó ‚Üí' : 'Ê¨°„Å∏';

  holdStart = 0;
  isInRange = false;
}

function advanceNote(){
  totalNotesCompleted++;
  currentIdx++;

  if(currentIdx >= selectedNotes.length){
    if(practiceMode === 'repeat'){
      repeatRound++;
      currentIdx = 0;
    } else {
      if(practiceMode === 'timeattack'){
        taRunning = false;
        taElapsed = performance.now() - taStart;
      }
      showResult();
      return;
    }
  }
  updateTarget();
}

function showResult(){
  showScreen('result');
  var icon = document.getElementById('resultIcon');
  var title = document.getElementById('resultTitle');
  var sub = document.getElementById('resultSub');

  if(practiceMode === 'timeattack'){
    var isComplete = currentIdx >= selectedNotes.length;
    icon.textContent = '‚è±Ô∏è';
    title.textContent = (taElapsed / 1000).toFixed(1) + 'Áßí';
    sub.textContent = isComplete
      ? totalNotesCompleted + 'Èü≥„ÇØ„É™„Ç¢ÔºÅ'
      : totalNotesCompleted + '/' + selectedNotes.length + 'Èü≥Ôºà‰∏≠Êñ≠Ôºâ';
  } else if(practiceMode === 'repeat'){
    var fullRounds = Math.max(0, repeatRound - 1);
    icon.textContent = 'üîÑ';
    title.textContent = fullRounds + 'Âë®ÂÆå‰∫Ü';
    sub.textContent = totalNotesCompleted + 'Èü≥Á∑¥Áøí„Åó„Åæ„Åó„Åü';
  } else {
    icon.textContent = '‚úÖ';
    title.textContent = 'ÂÆå‰∫ÜÔºÅ';
    sub.textContent = '„Åô„Åπ„Å¶„ÅÆÈü≥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü';
  }
}

function handleStop(){
  taRunning = false;
  if(practiceMode === 'timeattack'){
    taElapsed = performance.now() - taStart;
    showResult();
  } else if(practiceMode === 'repeat' && totalNotesCompleted > 0){
    showResult();
  } else {
    showScreen('setup');
  }
}

function updateDetection(freq){
  if(currentScreen !== 'practice' || currentIdx >= selectedNotes.length) return;
  var midi = selectedNotes[currentIdx].midi;
  var range = getRange(midi);

  if(freq <= 0){
    silCnt++;
    if(silCnt > 15){
      smoothPitch = 0;
      document.getElementById('detectHz').textContent = '---';
      document.getElementById('detectHz').className = 'detect-hz pos-silent';
      document.getElementById('detectPos').textContent = 'Èü≥„ÇíÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
      document.getElementById('detectPos').className = 'detect-pos pos-silent';
      document.getElementById('detectCents').textContent = '';
      drawZone(midi, null);
      holdStart = 0; isInRange = false;
      if(practiceMode !== 'confirm') document.getElementById('autoFill').style.width = '0%';
    }
    return;
  }

  silCnt = 0;
  if(smoothPitch === 0 || Math.abs(centsFrom(freq, smoothPitch)) > 80) smoothPitch = freq;
  else smoothPitch = smoothPitch * 0.7 + freq * 0.3;

  var cents = centsFrom(smoothPitch, range.etHz);
  var inRange = cents >= range.lo && cents <= range.hi;

  document.getElementById('detectHz').textContent = smoothPitch.toFixed(1) + ' Hz';
  document.getElementById('detectCents').textContent = (cents >= 0 ? '+' : '') + cents.toFixed(1) + ' cent';

  var posText, posClass;
  if(inRange){
    if(cents < -4){ posText = '‰Ωé„ÇÅ'; posClass = 'pos-low'; }
    else if(cents > 4){ posText = 'È´ò„ÇÅ'; posClass = 'pos-high'; }
    else { posText = '„Éî„Ç¢„ÉéÂØÑ„Çä'; posClass = 'pos-piano'; }
    document.getElementById('detectHz').className = 'detect-hz ' + posClass;
  } else {
    var targetMidi = midi;
    var detectedMidi = Math.round(69 + 12 * Math.log2(smoothPitch / A4));
    var semitoneDiff = detectedMidi - targetMidi;

    if(Math.abs(semitoneDiff) >= 2){
      var detName = getDetectedNoteName(smoothPitch);
      if(semitoneDiff < 0){
        posText = detName + ' ‚Üí „ÇÇ„Å£„Å®È´ò„Åè';
      } else {
        posText = detName + ' ‚Üí „ÇÇ„Å£„Å®‰Ωé„Åè';
      }
    } else {
      if(cents < range.lo){ posText = '‚Üë „ÇÇ„Å£„Å®È´ò„Åè'; }
      else { posText = '‚Üì „ÇÇ„Å£„Å®‰Ωé„Åè'; }
    }
    posClass = 'pos-out';
    document.getElementById('detectHz').className = 'detect-hz pos-out';
  }
  document.getElementById('detectPos').textContent = posText;
  document.getElementById('detectPos').className = 'detect-pos ' + posClass;

  drawZone(midi, cents);

  // Auto advance for auto/repeat/timeattack
  if(practiceMode !== 'confirm'){
    var holdMs = getHoldMs();
    if(inRange){
      if(!isInRange){ holdStart = Date.now(); isInRange = true; }
      var elapsed = Date.now() - holdStart;
      var pct = Math.min(100, elapsed / holdMs * 100);
      document.getElementById('autoFill').style.width = pct + '%';
      if(elapsed >= holdMs){
        advanceNote();
      }
    } else {
      holdStart = 0; isInRange = false;
      document.getElementById('autoFill').style.width = '0%';
    }
  }

  if(practiceMode === 'confirm'){
    isInRange = inRange;
  }
}

// ===== AUDIO =====
async function startAudio(){
  var errEl = document.getElementById('errorMsg');
  try {
    if(location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1' && location.hostname !== ''){
      errEl.textContent = 'HTTPSÁí∞Â¢É„ÅåÂøÖË¶Å„Åß„Åô'; errEl.style.display = 'block'; return;
    }
    var AC = window.AudioContext || window.webkitAudioContext;
    if(!AC){ errEl.textContent = 'Web Audio APIÈùûÂØæÂøú'; errEl.style.display = 'block'; return; }

    audioCtx = new AC();
    await audioCtx.resume();
    var stream = await navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false }
    });
    var src = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 4096;
    src.connect(analyser);
    audioBuf = new Float32Array(analyser.fftSize);
    isRunning = true;
    showScreen('setup');
    tick();
  } catch(e){
    errEl.textContent = e.name === 'NotAllowedError'
      ? '„Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇË®≠ÂÆö„Åã„ÇâË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
      : '„Éû„Ç§„ÇØÂàùÊúüÂåñÂ§±Êïó: ' + e.message;
    errEl.style.display = 'block';
  }
}

function tick(){
  if(!isRunning) return;
  try {
    analyser.getFloatTimeDomainData(audioBuf);
    var r = rms(audioBuf);
    if(r < 0.01){
      updateDetection(-1);
    } else {
      var f = yin(audioBuf, audioCtx.sampleRate);
      if(f > 170 && f < 3200){
        updateDetection(f);
      } else {
        updateDetection(-1);
      }
    }
  } catch(e){}
  requestAnimationFrame(tick);
}

// ===== SCREEN NAV =====
function showScreen(name){
  currentScreen = name;
  ['startScreen','setupScreen','practiceScreen','resultScreen'].forEach(function(id){
    document.getElementById(id).classList.remove('visible');
  });
  document.getElementById(name + 'Screen').classList.add('visible');
  document.getElementById('startScreen').style.display = name === 'start' ? 'flex' : 'none';

  if(name === 'setup'){
    buildNoteGrid();
    renderSelected();
  }
  if(name === 'practice'){
    setTimeout(function(){ setupStaff(); setupZone(); }, 30);
  }
}

// ===== EVENT LISTENERS =====
document.getElementById('startBtn').addEventListener('click', startAudio);

// Mode toggle
document.querySelectorAll('.mode-opt').forEach(function(btn){
  btn.addEventListener('click', function(){
    practiceMode = btn.dataset.mode;
    document.querySelectorAll('.mode-opt').forEach(function(b){
      b.classList.toggle('active', b.dataset.mode === practiceMode);
    });
  });
});

// Difficulty toggle
document.querySelectorAll('.diff-opt').forEach(function(btn){
  btn.addEventListener('click', function(){
    difficulty = btn.dataset.diff;
    document.querySelectorAll('.diff-opt').forEach(function(b){
      b.classList.toggle('active', b.dataset.diff === difficulty);
    });
  });
});

document.getElementById('selClear').addEventListener('click', function(){
  selectedNotes = [];
  renderSelected();
});

document.getElementById('selStart').addEventListener('click', startPractice);

document.getElementById('confirmBtn').addEventListener('click', function(){
  advanceNote();
});

document.getElementById('pracStop').addEventListener('click', handleStop);
document.getElementById('pracStop2').addEventListener('click', handleStop);

document.getElementById('resultRetry').addEventListener('click', startPractice);
document.getElementById('resultBack').addEventListener('click', function(){ showScreen('setup'); });

window.addEventListener('resize', function(){
  if(currentScreen === 'practice'){
    setupStaff(); setupZone();
    if(currentIdx < selectedNotes.length){
      drawStaff(selectedNotes[currentIdx]);
      drawZone(selectedNotes[currentIdx].midi, null);
    }
  }
});

document.addEventListener('visibilitychange', function(){
  if(audioCtx && !document.hidden) audioCtx.resume();
});
document.addEventListener('touchstart', function(){
  if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
}, { passive: true });

})();
</script>
</body>
</html>
